name: Release

on:
  push:
    tags:
      - 'v*' # Triggers on version tags like v6.3.2

permissions:
  contents: write

jobs:
  build-windows:
    name: Build Windows
    runs-on: windows-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable

      - name: Cache Rust dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            src-tauri/target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Install dependencies
        run: npm ci

      - name: Build frontend
        run: npm run build

      - name: Build Tauri app for Windows
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # The Tauri CLI specifically looks for TAURI_PRIVATE_KEY for signing
          TAURI_PRIVATE_KEY: 'dW50cnVzdGVkIGNvbW1lbnQ6IHJzaWduIGVuY3J5cHRlZCBzZWNyZXQga2V5ClJXUlRZMEl5Qi9WRVd0WUdmNitEcHhCL0E4MWk3SUdsbytIdzFZWHgxUXhNaVdlMmsrTUFBQkFBQUFBQUFBQUFBQUlBQUFBQTRWS2pyeTVyTkFwalFscDdPUWR1eEdqRHJWNmdQV2Rmb3dwN1NWV05ZYm9HUytsclhUelZKcUpHSWJNeDNVb1hVb21BMzJESnZkZ3ZpQ3hzcCtxQ20zRzBFWXhka3VyMEl2M3ZYY3FLNFhVVnNYVjgvMHVUZlRqU2FmYmpYMUR5WU1HL1M2QUtIN2s9Cg=='
          TAURI_KEY_PASSWORD: "" 
        with:
          projectPath: src-tauri
          tagName: ${{ github.ref_name }}
          releaseName: 'شفاف ${{ github.ref_name }}'
          releaseBody: 'See the assets to download this version and install.'
          releaseDraft: false
          prerelease: false
          # This creates the .sig files and latest.json automatically
          includeUpdater: true
          args: '--bundles nsis'

      - name: Generate and upload latest.json if missing
        shell: pwsh
        run: |
          Write-Host "Checking if latest.json exists in release assets..."
          $releaseUrl = "https://api.github.com/repos/${{ github.repository }}/releases/tags/${{ github.ref_name }}"
          $headers = @{
            "Authorization" = "token ${{ secrets.GITHUB_TOKEN }}"
            "Accept" = "application/vnd.github.v3+json"
          }
          
          try {
            # Wait a bit for assets to be fully uploaded
            Start-Sleep -Seconds 5
            
            $response = Invoke-RestMethod -Uri $releaseUrl -Headers $headers -Method Get
            
            # Debug: List all assets
            Write-Host "Available assets:"
            $response.assets | ForEach-Object { Write-Host "  - $($_.name)" }
            
            $latestJson = $response.assets | Where-Object { $_.name -eq "latest.json" }
            
            if ($latestJson) {
              Write-Host "✅ latest.json already exists in release assets: $($latestJson.browser_download_url)"
            } else {
              Write-Host "latest.json not found. Generating and uploading..."
              
              # Find the installer file (try multiple patterns)
              $installer = $response.assets | Where-Object { 
                $_.name -like "*.exe" -and $_.name -notlike "*.sig" 
              } | Select-Object -First 1
              
              if (-not $installer) {
                Write-Host "Available files:"
                $response.assets | ForEach-Object { Write-Host "  - $($_.name)" }
                Write-Host "::error::Could not find installer file in release assets"
                exit 1
              }
              
              Write-Host "Found installer: $($installer.name)"
              
              # Find the signature file (try multiple patterns)
              $signature = $response.assets | Where-Object { 
                $_.name -like "*.sig" -or 
                $_.name -like "*$($installer.name).sig" -or
                ($_.name -eq "$($installer.name).sig")
              } | Select-Object -First 1
              
              if (-not $signature) {
                Write-Host "Warning: Could not find signature file in release assets"
                Write-Host "Available files:"
                $response.assets | ForEach-Object { Write-Host "  - $($_.name)" }
                Write-Host "Attempting to create latest.json without signature (updater may not work)..."
                
                # Create latest.json without signature
                $version = "${{ github.ref_name }}" -replace '^v', ''
                $pubDate = (Get-Date).ToUniversalTime().ToString("yyyy-MM-ddTHH:mm:ssZ")
                
                $latestJsonContent = @{
                  version = "${{ github.ref_name }}"
                  notes = "See the assets to download this version and install."
                  pub_date = $pubDate
                  platforms = @{
                    "windows-x86_64" = @{
                      url = $installer.browser_download_url
                    }
                  }
                } | ConvertTo-Json -Depth 10
              } else {
                Write-Host "Found signature file: $($signature.name)"
                
                # Get signature content (trim whitespace)
                $sigContent = ((Invoke-WebRequest -Uri $signature.browser_download_url -Headers $headers).Content).Trim()
                
                # Extract version from tag (remove 'v' prefix if present)
                $version = "${{ github.ref_name }}" -replace '^v', ''
                
                # Get current date in ISO format
                $pubDate = (Get-Date).ToUniversalTime().ToString("yyyy-MM-ddTHH:mm:ssZ")
                
                # Create latest.json content
                $latestJsonContent = @{
                  version = "${{ github.ref_name }}"
                  notes = "See the assets to download this version and install."
                  pub_date = $pubDate
                  platforms = @{
                    "windows-x86_64" = @{
                      signature = $sigContent
                      url = $installer.browser_download_url
                    }
                  }
                } | ConvertTo-Json -Depth 10
              }
              
              # Save to file
              $latestJsonContent | Out-File -FilePath "latest.json" -Encoding utf8
              
              Write-Host "latest.json content generated. Will upload in next step."
            }
          } catch {
            Write-Host "::error::Could not process release: $_"
            Write-Host $_.Exception.Message
            Write-Host $_.ScriptStackTrace
            exit 1
          }

      - name: Upload latest.json if generated
        shell: pwsh
        run: |
          if (Test-Path "latest.json") {
            Write-Host "Uploading latest.json to release..."
            $releaseUrl = "https://api.github.com/repos/${{ github.repository }}/releases/tags/${{ github.ref_name }}"
            $headers = @{
              "Authorization" = "token ${{ secrets.GITHUB_TOKEN }}"
              "Accept" = "application/vnd.github.v3+json"
            }
            $response = Invoke-RestMethod -Uri $releaseUrl -Headers $headers -Method Get
            
            $filePath = Resolve-Path "latest.json"
            $fileContent = Get-Content $filePath -Raw
            
            $uploadUrl = "https://uploads.github.com/repos/${{ github.repository }}/releases/$($response.id)/assets?name=latest.json"
            $uploadHeaders = @{
              "Authorization" = "token ${{ secrets.GITHUB_TOKEN }}"
              "Content-Type" = "application/json"
            }
            
            try {
              $bodyBytes = [System.Text.Encoding]::UTF8.GetBytes($fileContent)
              Invoke-RestMethod -Uri $uploadUrl -Method Post -Headers $uploadHeaders -Body $bodyBytes
              Write-Host "✅ Successfully uploaded latest.json"
            } catch {
              Write-Host "::error::Failed to upload: $_"
              if ($_.Exception.Response) {
                $stream = $_.Exception.Response.GetResponseStream()
                $reader = New-Object System.IO.StreamReader($stream)
                $responseBody = $reader.ReadToEnd()
                Write-Host "Response: $responseBody"
              }
              exit 1
            }
          } else {
            Write-Host "latest.json not generated, skipping upload"
          }

      - name: Release link
        run: echo "::notice title=Release::https://github.com/${{ github.repository }}/releases/tag/${{ github.ref_name }}"

  # build-android:
  #   name: Build Android
  #   runs-on: ubuntu-latest
  #   needs: [build-windows]
  #   steps:
  #     - name: Checkout repository
  #       uses: actions/checkout@v4

  #     - name: Setup Node.js
  #       uses: actions/setup-node@v4
  #       with:
  #         node-version: '20'
  #         cache: 'npm'

  #     - name: Setup Java
  #       uses: actions/setup-java@v4
  #       with:
  #         distribution: 'temurin'
  #         java-version: '17'

  #     - name: Setup Android SDK
  #       uses: android-actions/setup-android@v3

  #     - name: Install Rust
  #       uses: dtolnay/rust-toolchain@stable
  #       with:
  #         toolchain: stable

  #     - name: Cache Rust dependencies
  #       uses: actions/cache@v4
  #       with:
  #         path: |
  #           ~/.cargo/bin/
  #           ~/.cargo/registry/index/
  #           ~/.cargo/registry/cache/
  #           ~/.cargo/git/db/
  #           src-tauri/target/
  #         key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

  #     - name: Install Rust Android targets
  #       run: |
  #         rustup target add aarch64-linux-android \
  #                           armv7-linux-androideabi \
  #                           i686-linux-android \
  #                           x86_64-linux-android

  #     - name: Install cargo-ndk
  #       run: cargo install cargo-ndk --locked

  #     - name: Install dependencies
  #       run: npm ci

  #     - name: Build frontend
  #       run: npm run build

  #     - name: Create CI keystore
  #       run: |
  #         mkdir -p src-tauri/gen/android
  #         keytool -genkeypair -v -keystore src-tauri/gen/android/ci.keystore \
  #           -keyalg RSA -keysize 2048 -validity 10000 -alias shafaf \
  #           -storepass android -keypass android \
  #           -dname "CN=CI, OU=CI, O=CI, L=CI, S=CI, C=US"

  #     - name: Build Tauri app for Android
  #       run: npm run tauri android build
  #       env:
  #         ANDROID_HOME: ${{ env.ANDROID_SDK_ROOT }}
  #         ANDROID_NDK_HOME: ${{ env.ANDROID_NDK_ROOT }}
  #         KEYSTORE_PATH: ${{ github.workspace }}/src-tauri/gen/android/ci.keystore
  #         KEYSTORE_PASSWORD: android
  #         KEY_ALIAS: shafaf
  #         KEY_PASSWORD: android

  #     - name: Upload Android Assets
  #       uses: softprops/action-gh-release@v1
  #       with:
  #         tag_name: ${{ github.ref_name }}
  #         files: |
  #           src-tauri/gen/android/app/build/outputs/apk/universal/release/*.apk
  #           src-tauri/gen/android/app/build/outputs/bundle/universalRelease/*.aab
  #       env:
  #         GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
