name: Release

on:
  push:
    tags:
      - 'v*'  # Triggers on version tags like v6.3.2

# Required for tauri-action and action-gh-release to create/update releases.
# If you see "Resource not accessible by integration": set Settings → Actions →
# General → Workflow permissions to "Read and write permissions".
permissions:
  contents: write

jobs:
  build-windows:
    name: Build Windows
    runs-on: windows-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable

      - name: Cache Rust dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            src-tauri/target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Install dependencies
        run: npm ci

      - name: Setup Tauri signing key
        if: env.TAURI_SIGNING_PRIVATE_KEY != ''
        env:
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
        run: |
          echo "$TAURI_SIGNING_PRIVATE_KEY" > ${{ runner.temp }}/tauri-signing-key.key
          echo "Signing key configured"

      - name: Build frontend
        run: npm run build

      - name: Build Tauri app for Windows
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
        with:
          projectPath: src-tauri
          tagName: ${{ github.ref_name }}
          releaseName: 'شفاف v${{ github.ref_name }}'
          releaseBody: 'See the assets to download this version and install.'
          releaseDraft: false
          prerelease: false
          args: '--bundles nsis'

      - name: Sign installer and generate update manifest
        if: env.TAURI_SIGNING_PRIVATE_KEY != ''
        env:
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
        run: |
          # Find the built installer
          $installer = Get-ChildItem -Path "src-tauri\target\release\bundle\nsis" -Filter "*.exe" | Select-Object -First 1
          if (-not $installer) {
            Write-Host "Installer not found"
            exit 1
          }
          
          Write-Host "Found installer: $($installer.FullName)"
          
          # Verify the key is set
          if (-not $env:TAURI_SIGNING_PRIVATE_KEY) {
            Write-Host "Error: TAURI_SIGNING_PRIVATE_KEY environment variable is not set"
            exit 1
          }
          Write-Host "Private key is set (length: $($env:TAURI_SIGNING_PRIVATE_KEY.Length))"
          
          # Write key to file for more reliable access
          $keyFile = "${{ runner.temp }}\tauri-signing-key.key"
          [System.IO.File]::WriteAllText($keyFile, $env:TAURI_SIGNING_PRIVATE_KEY)
          
          # Sign the installer using key file
          npx @tauri-apps/cli signer sign "$($installer.FullName)" --key-file "$keyFile"
          
          # Get version from tag (remove 'v' prefix)
          $version = "${{ github.ref_name }}" -replace '^v', ''
          
          # Get installer filename
          $installerName = $installer.Name
          
          # Generate signature file path
          $sigFile = "$($installer.FullName).sig"
          
          # Read signature
          $signature = ""
          if (Test-Path $sigFile) {
            $signature = Get-Content $sigFile -Raw
            $signature = $signature.Trim()
          }
          
          # Get download URL
          $downloadUrl = "https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/$installerName"
          
          # Get current date in ISO format
          $pubDate = (Get-Date).ToUniversalTime().ToString("yyyy-MM-ddTHH:mm:ssZ")
          
          # Create latest.json
          $latestJson = @{
            version = $version
            notes = "See the assets to download this version and install."
            pub_date = $pubDate
            platforms = @{
              "windows-x86_64" = @{
                signature = $signature
                url = $downloadUrl
              }
            }
          } | ConvertTo-Json -Depth 10
          
          # Save latest.json
          $latestJson | Out-File -FilePath "latest.json" -Encoding utf8
          Write-Host "Generated latest.json"
          Write-Host $latestJson

      - name: Upload latest.json to release
        if: env.TAURI_SIGNING_PRIVATE_KEY != ''
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          files: latest.json
          fail_on_unmatched_files: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Release link
        run: |
          echo "::notice title=Release::https://github.com/${{ github.repository }}/releases/tag/${{ github.ref_name }}"

  build-android:
    name: Build Android
    runs-on: ubuntu-latest
    needs: [build-windows]   # Run after Windows so we add APK/AAB to the same release
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable

      - name: Cache Rust dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            src-tauri/target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Install Rust Android targets
        run: |
          rustup target add aarch64-linux-android
          rustup target add armv7-linux-androideabi
          rustup target add i686-linux-android
          rustup target add x86_64-linux-android

      - name: Install cargo-ndk
        run: cargo install cargo-ndk --locked

      - name: Install dependencies
        run: npm ci

      - name: Initialize Android project (if needed)
        run: |
          if [ ! -d "src-tauri/gen/android" ]; then
            npm run tauri android init
          fi
        continue-on-error: true

      - name: Build frontend
        run: npm run build

      - name: Create CI keystore for Android release signing
        run: |
          mkdir -p src-tauri/gen/android
          keytool -genkeypair -v -keystore src-tauri/gen/android/ci.keystore \
            -keyalg RSA -keysize 2048 -validity 10000 -alias shafaf \
            -storepass android -keypass android \
            -dname "CN=CI, OU=CI, O=CI, L=CI, S=CI, C=US"

      - name: Build Tauri app for Android
        run: npm run tauri android build
        env:
          ANDROID_HOME: ${{ env.ANDROID_SDK_ROOT }}
          ANDROID_NDK_HOME: ${{ env.ANDROID_NDK_ROOT }}
          KEYSTORE_PATH: ${{ github.workspace }}/src-tauri/gen/android/ci.keystore
          KEYSTORE_PASSWORD: android
          KEY_ALIAS: shafaf
          KEY_PASSWORD: android

      - name: Upload Android APK and AAB to Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          files: |
            src-tauri/gen/android/app/build/outputs/apk/universal/release/*.apk
            src-tauri/gen/android/app/build/outputs/bundle/universalRelease/*.aab
          fail_on_unmatched_files: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Release and APK links
        run: |
          echo "::notice title=Release page::https://github.com/${{ github.repository }}/releases/tag/${{ github.ref_name }}"
          for f in src-tauri/gen/android/app/build/outputs/apk/universal/release/*.apk; do
            [ -f "$f" ] && echo "::notice title=APK::https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/$(basename "$f")"
          done
          for f in src-tauri/gen/android/app/build/outputs/bundle/universalRelease/*.aab; do
            [ -f "$f" ] && echo "::notice title=AAB (Play Store)::https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/$(basename "$f")"
          done
